version: "2"

services:

  php:
    build: .
    image: keboola/mongodb-extractor
    tty: true
    stdin_open: true
    links:
      - mongodb
      - mongodb-3
      - ssh-tunnel
      - mongodb-auth
      - ssh-tunnel-for-auth
    command: >
             sh -c '
             sleep 4
             && mongoimport --host mongodb --db test --collection restaurants --drop --file tests/dataset.json
             && mongoimport --host mongodb --db test --collection restaurantsIdAsString --drop --file tests/dataset-id-as-string.json
             && mongoimport --host mongodb-3 --db test --collection mixedIds --drop --file tests/dataset-mixed-ids.json
             && mongoimport --host mongodb-auth --username user --password user --db test --collection restaurants --drop --file tests/dataset.json
             && bash
             '
    volumes:
      - ./:/code
      - ./docker/php/php.ini:/usr/local/etc/php/php.ini

  php-tests:
    build:
      context: .
      dockerfile: Dockerfile-tests
    links:
      - mongodb
      - mongodb-3
      - ssh-tunnel
      - mongodb-auth
      - ssh-tunnel-for-auth
    command: >
             sh -c '
             sleep 4
             && mongoimport --host mongodb --db test --collection restaurants --drop --file tests/dataset.json
             && mongoimport --host mongodb --db test --collection restaurantsIdAsString --drop --file tests/dataset-id-as-string.json
             && mongoimport --host mongodb-3 --db test --collection mixedIds --drop --file tests/dataset-mixed-ids.json
             && mongoimport --host mongodb-auth --username user --password user --db test --collection restaurants --drop --file tests/dataset.json
             && ./tests.sh
             '
    volumes:
      - ./docker/php/php.ini:/usr/local/etc/php/php.ini

  php-tests-with-report:
    build:
      context: .
      dockerfile: Dockerfile-tests
    links:
      - mongodb
      - mongodb-3
      - ssh-tunnel
      - mongodb-auth
      - ssh-tunnel-for-auth
    command: >
             sh -c '
             sleep 4
             && mongoimport --host mongodb --db test --collection restaurants --drop --file tests/dataset.json
             && mongoimport --host mongodb --db test --collection restaurantsIdAsString --drop --file tests/dataset-id-as-string.json
             && mongoimport --host mongodb-3 --db test --collection mixedIds --drop --file tests/dataset-mixed-ids.json
             && mongoimport --host mongodb-auth --username user --password user --db test --collection restaurants --drop --file tests/dataset.json
             && ./tests.sh
             && ./vendor/bin/test-reporter
             '
    volumes:
      - ./.git:/code/.git
      - ./docker/php/php.ini:/usr/local/etc/php/php.ini

  mongodb:
    image: mongo:3.2

  mongodb-auth:
    extends:
      service: mongodb
    volumes:
      - ./docker/mongodb/init-auth.js:/init.js
    command: >
             sh -c '
             sh -c "mongod &"
             && sleep 2
             && mongo < /init.js
             && mongod --shutdown
             && mongod --auth
             '

  ssh-tunnel:
    image: quay.io/keboola/mongodb-extractor-ssh
    links:
      - mongodb:mongodb-behind-ssh

  ssh-tunnel-for-auth:
    image: quay.io/keboola/mongodb-extractor-ssh
    links:
      - mongodb-auth:mongodb-auth-behind-ssh

  mongodb-3:
    image: mongo:3.0
